name: Deploy App Cobranzas

on:
  push:
    branches:
      - cobranzas_qa_am

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SSH_PRIVATE_KEY: ${{ secrets.PEM_COBRANZAS_QA }}
      REMOTE_USER: ec2-user
      REMOTE_HOST: ${{ secrets.IP_COBRANZAS_QA }}
      GITHUB_TOKEN: ${{ secrets.TOKEN_GH_AM }}
      APP_NAME: app.js
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME_AM }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN_AM }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD_AM }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Packages
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            sudo yum update -y
            sudo yum install nodejs npm git -y

      - name: Create a Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            sudo rm -rf /opt/cobranzas_qa || true
            cd /opt
            sudo mkdir -p cobranzas_qa

      - name: Clone repository
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/cobranzas_qa
            sudo git clone -b cobranzas_qa_am https://github.com/alkemyTech/UMSA-DevOps-T1.git /opt/cobranzas_qa

      - name: Install npm packages
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/cobranzas_qa
            sudo npm install -g express pm2

      - name: Start Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/cobranzas_qa
            sudo pm2 delete app.js || true
            sudo pm2 start app.js --name 'app.js'

      - name: Check if app is running
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            if sudo pm2 ls | grep -q '${{ env.APP_NAME }}'; then
              echo "El servicio ${{ env.APP_NAME }} est치 en ejecuci칩n."
            else
              echo "El servicio ${{ env.APP_NAME }} no est치 en ejecuci칩n."
              exit 1
            fi

      - name: SSH into EC2 instance and set up Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            sudo yum update -y
            sudo yum install docker -y
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG wheel ec2-user 
            sudo chmod -R u+w /opt/cobranzas_qa

      - name: Generar Imagen Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            if [ ! -f /opt/cobranzas_qa/Dockerfile ]; then
              echo "Dockerfile not found."
              exit 1
            fi

            echo "FROM node:14" > /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo "WORKDIR /app" >> /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo "COPY package.json ." >> /opt/cobranzas_qa/Dockerfile
            echo "COPY package-lock.json ." >> /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo "RUN npm install" >> /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo "COPY . ." >> /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo "EXPOSE 8080" >> /opt/cobranzas_qa/Dockerfile
            echo "" >> /opt/cobranzas_qa/Dockerfile
            echo 'CMD ["node", "app.js"]' >> /opt/cobranzas_qa/Dockerfile

            docker build -t cobranzas_qa:v1 /opt/cobranzas_qa
            docker stop cont_cobranzas_qa || true
            docker rm cont_cobranzas_qa || true
            docker run -d --name cont_cobranzas_qa cobranzas_qa:v1

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_PASSWORD }}

      - name: Push to DockerHub
        uses: docker/build-push-action@v5.3.0
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/cobranzas_qa:v1
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Stop and remove existing container (if exists)
        run: |
          docker stop cobranzas_qa || true
          docker rm cobranzas_qa || true

      - name: Run new container with the freshly pulled image
        run: |
          docker run -d --name cobranzas_qa -p 8080:8080 ${{ env.DOCKERHUB_USERNAME }}/cobranzas_qa:v1
